name: Snowflake Terraform Deploy

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      # --- ç¬¬ä¸€é˜¶æ®µï¼šTerraform (æ‰“åœ°åŸºï¼šåº“ã€Schemaã€Stageã€å¼€å…³Stream) ---
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Init
        run: |
          cd terraform
          terraform init

      - name: Terraform Smart Import
        continue-on-error: true
        env:
          SNOWFLAKE_ORGANIZATION_NAME: "TMJESFF"
          SNOWFLAKE_ACCOUNT_NAME:      "ED32433"
          SNOWFLAKE_USER:              ${{ secrets.SNOWFLAKE_USER }}
          SNOWFLAKE_PASSWORD:          ${{ secrets.SNOWFLAKE_PASSWORD }}
          SNOWFLAKE_ROLE:              "ACCOUNTADMIN"
        run: |
          cd terraform
          
          smart_import() {
            local res=$1; local id=$2
            if ! terraform state list | grep -q "$res"; then
              echo "--- Importing $res using ID $id ---"
              terraform import "$res" "$id" || true
            fi
          }

          # 1. Database & Integration
          smart_import "snowflake_database.cosmetics_db" "COSMETICS_DB_DEV"
          smart_import "snowflake_storage_integration.s3_int" "S3_INT_NEW"
          smart_import "snowflake_external_volume.cosmetics_volume" "COSMETICS_S3_VOLUME"
          
          # 2. Schema 
          smart_import "snowflake_schema.cosmetics_schema" "COSMETICS_DB_DEV.COSMETICS"
          
          # 3. Stages 
          smart_import "snowflake_stage.cosmetics_s3_stage" "COSMETICS_DB_DEV|COSMETICS|COSMETICS_S3_STAGE"
          smart_import "snowflake_stage.trigger_stage" "COSMETICS_DB_DEV|COSMETICS|COSMETICS_TRIGGER_S3_STAGE"
          
          # 4. Stream 
          smart_import "snowflake_stream_on_directory_table.trigger_stream" "COSMETICS_DB_DEV.COSMETICS.TRIGGER_S3_FILE_STREAM"

      - name: Terraform Apply
        env:
          SNOWFLAKE_ORGANIZATION_NAME: "TMJESFF"
          SNOWFLAKE_ACCOUNT_NAME:      "ED32433"
          SNOWFLAKE_USER:              ${{ secrets.SNOWFLAKE_USER }}
          SNOWFLAKE_PASSWORD:          ${{ secrets.SNOWFLAKE_PASSWORD }}
          SNOWFLAKE_ROLE:              "ACCOUNTADMIN"
        run: |
          cd terraform
          terraform apply -auto-approve

      # --- ç¬¬äºŒé˜¶æ®µï¼šPython Snowpark (å»º Iceberg ä¸šåŠ¡è¡¨å’Œè¡¨çº§ Stream) ---
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Snowpark Dependencies
        run: |
          pip install snowflake-snowpark-python

      - name: Run Python Infrastructure Setup
        env:
          DEPLOY_ENV: "DEV"
        run: |
          # å¿…é¡»è¿›å…¥ infrastructure ç›®å½•ï¼Œä»¥ä¾¿ setup_tables.py å¯¼å…¥ setup.py
          cd infrastructure
          python setup_tables.py

      # --- ç¬¬ä¸‰é˜¶æ®µï¼šSQL (åˆ›å»º File Formatã€Pipeã€åˆ·æ–°ç¯å¢ƒ) ---
      - name: Run Infrastructure SQL via Python
        env:
          SNOWFLAKE_ACCOUNT: ${{ env.SNOWFLAKE_ACCOUNT }}
          SNOWFLAKE_USER: ${{ env.SNOWFLAKE_USER }}
          SNOWFLAKE_PASSWORD: ${{ env.SNOWFLAKE_PASSWORD }}
        run: |
          python -c "
          import os
          import snowflake.snowpark as snowpark
          
          # å»ºç«‹è¿æ¥
          session = snowpark.Session.builder.configs({
              'account': '${{ env.SNOWFLAKE_ACCOUNT }}',
              'user': '${{ env.SNOWFLAKE_USER }}',
              'password': '${{ env.SNOWFLAKE_PASSWORD }}',
              'role': 'ACCOUNTADMIN',
              'warehouse': 'COMPUTE_WH',
              'database': 'COSMETICS_DB_DEV',
              'schema': 'COSMETICS'
          }).create()
          
          try:
              print('ğŸš€ æ­£åœ¨æ‰§è¡Œè¾…åŠ© SQL è„šæœ¬...')
              with open('infrastructure/create_streams.sql', 'r') as f:
                  # ä»¥åˆ†å·åˆ†å‰² SQL è¯­å¥ï¼Œå¹¶è¿‡æ»¤æ‰ç©ºè¡Œ
                  queries = [q.strip() for q in f.read().split(';') if q.strip()]
                  for query in queries:
                      print(f'æ‰§è¡Œä¸­: {query[:50]}...')
                      session.sql(query).collect()
              print('âœ… SQL éƒ¨ç½²æˆåŠŸï¼')
          finally:
              session.close()
          "