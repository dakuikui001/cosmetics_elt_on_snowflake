name: Snowflake Infrastructure Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  SNOWFLAKE_ACCOUNT: "TMJESFF-ED32433"
  SNOWFLAKE_USER: ${{ secrets.SNOWFLAKE_USER }}
  SNOWFLAKE_PASSWORD: ${{ secrets.SNOWFLAKE_PASSWORD }}
  SNOWFLAKE_ROLE: "ACCOUNTADMIN"

jobs:
  check_changes:
    runs-on: ubuntu-latest
    outputs:
      infra_sql: ${{ steps.filter.outputs.infra_sql }}
      infra_all: ${{ steps.filter.outputs.infra_all }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            infra_sql:
              - 'infrastructure/setup_infra.sql'
            infra_all:
              - 'infrastructure/**'

  deploy:
    runs-on: ubuntu-latest
    needs: check_changes
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # --- ç¬¬ä¸€é˜¶æ®µï¼šTerraform ---
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Init & Apply
        env:
          SNOWFLAKE_ORGANIZATION_NAME: "TMJESFF"
          SNOWFLAKE_ACCOUNT_NAME:      "ED32433"
        run: |
          cd terraform
          terraform init
          terraform import snowflake_database.cosmetics_db COSMETICS_DB_DEV || true
          terraform import snowflake_schema.cosmetics_schema "COSMETICS_DB_DEV"."COSMETICS" || true
          terraform apply -auto-approve

      # --- ç¬¬äºŒé˜¶æ®µï¼šPython ç¯å¢ƒå‡†å¤‡ ---
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Snowpark Dependencies
        run: pip install snowflake-snowpark-python

      # --- ç¬¬ä¸‰é˜¶æ®µï¼šæ‰§è¡ŒåŸºç¡€è®¾æ–½ SQL (ä»…å½“ setup_infra.sql å˜åŠ¨æ—¶) ---
      # ğŸ”´ ä¿®æ­£ï¼šneeds åé¢è·Ÿçš„æ˜¯ç‚¹å· . 
      - name: Run Physical Infrastructure SQL
        if: needs.check_changes.outputs.infra_sql == 'true' || github.event_name == 'workflow_dispatch'
        env:
          SNOWFLAKE_ACCOUNT: ${{ env.SNOWFLAKE_ACCOUNT }}
          SNOWFLAKE_USER: ${{ env.SNOWFLAKE_USER }}
          SNOWFLAKE_PASSWORD: ${{ env.SNOWFLAKE_PASSWORD }}
        run: |
          python -c "
          import os, re
          import snowflake.snowpark as snowpark
          session = snowpark.Session.builder.configs({
              'account': '${{ env.SNOWFLAKE_ACCOUNT }}',
              'user': '${{ env.SNOWFLAKE_USER }}',
              'password': '${{ env.SNOWFLAKE_PASSWORD }}',
              'role': 'ACCOUNTADMIN'
          }).create()
          
          def is_valid_sql(sql):
              content = re.sub(r'--.*', '', sql)
              content = re.sub(r'/\*.*?\*/', '', content, flags=re.DOTALL)
              return len(content.strip()) > 0

          try:
              sql_file = 'infrastructure/setup_infra.sql'
              print(f'ğŸš€ æ­£åœ¨æ‰§è¡Œç‰©ç†å±‚éƒ¨ç½² (æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´): {sql_file}')
              with open(sql_file, 'r') as f:
                  queries = [q.strip() for q in f.read().split(';') if q.strip()]
                  for query in queries:
                      if is_valid_sql(query):
                          session.sql(query).collect()
              print('âœ… ç‰©ç†å±‚éƒ¨ç½²æˆåŠŸï¼')
          except Exception as e:
              print(f'âŒ æ‰§è¡Œå¤±è´¥: {str(e)}')
              exit(1)
          finally:
              session.close()
          "

      # --- ç¬¬å››é˜¶æ®µï¼šè¿è¡Œ Python å»ºè¡¨ (ä»…å½“ infrastructure æ–‡ä»¶å¤¹ä¸‹æœ‰å˜åŠ¨æ—¶) ---
      # ğŸ”´ ä¿®æ­£ï¼šneeds åé¢è·Ÿçš„æ˜¯ç‚¹å· .
      - name: Run Table & Stream Setup
        if: needs.check_changes.outputs.infra_all == 'true' || github.event_name == 'workflow_dispatch'
        env:
          SNOWFLAKE_ACCOUNT: ${{ env.SNOWFLAKE_ACCOUNT }}
          SNOWFLAKE_USER: ${{ env.SNOWFLAKE_USER }}
          SNOWFLAKE_PASSWORD: ${{ env.SNOWFLAKE_PASSWORD }}
          DEPLOY_ENV: "DEV"
        run: |
          cd infrastructure
          python setup_tables.py