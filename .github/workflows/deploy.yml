name: Snowflake Infrastructure Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

# å…¨å±€ç¯å¢ƒå˜é‡ï¼šåœ¨è¿™é‡Œå®šä¹‰ä¸€æ¬¡ï¼Œä¸‹æ–¹æ‰€æœ‰ Steps éƒ½å¯ä»¥é€šè¿‡ env.XXX å¼•ç”¨
env:
  SNOWFLAKE_ACCOUNT: "TMJESFF-ED32433"
  SNOWFLAKE_USER: ${{ secrets.SNOWFLAKE_USER }}
  SNOWFLAKE_PASSWORD: ${{ secrets.SNOWFLAKE_PASSWORD }}
  SNOWFLAKE_ROLE: "ACCOUNTADMIN"

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # --- ç¬¬ä¸€é˜¶æ®µï¼šTerraform ---
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Init
        run: |
          cd terraform
          terraform init

      - name: Terraform Smart Import
        continue-on-error: true
        env:
          SNOWFLAKE_ORGANIZATION_NAME: "TMJESFF"
          SNOWFLAKE_ACCOUNT_NAME:      "ED32433"
        run: |
          cd terraform
          smart_import() {
            local res=$1; local id=$2
            if ! terraform state list | grep -q "$res"; then
              terraform import "$res" "$id" || true
            fi
          }
          smart_import "snowflake_database.cosmetics_db" "COSMETICS_DB_DEV"
          smart_import "snowflake_storage_integration.s3_int" "S3_INT_NEW"
          smart_import "snowflake_external_volume.cosmetics_volume" "COSMETICS_S3_VOLUME"
          smart_import "snowflake_schema.cosmetics_schema" "COSMETICS_DB_DEV.COSMETICS"
          smart_import "snowflake_stage.cosmetics_s3_stage" "COSMETICS_DB_DEV|COSMETICS|COSMETICS_S3_STAGE"
          smart_import "snowflake_stage.trigger_stage" "COSMETICS_DB_DEV|COSMETICS|COSMETICS_TRIGGER_S3_STAGE"
          smart_import "snowflake_stream_on_directory_table.trigger_stream" "COSMETICS_DB_DEV.COSMETICS.TRIGGER_S3_FILE_STREAM"

      - name: Terraform Apply
        env:
          SNOWFLAKE_ORGANIZATION_NAME: "TMJESFF"
          SNOWFLAKE_ACCOUNT_NAME:      "ED32433"
        run: |
          cd terraform
          terraform apply -auto-approve

      # --- ç¬¬äºŒé˜¶æ®µï¼šPython Snowpark (ä¿®å¤äº†ç¯å¢ƒå˜é‡ä¼ é€’) ---
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Snowpark Dependencies
        run: pip install snowflake-snowpark-python

      - name: Run Python Infrastructure Setup
        env:
          # æ˜¾å¼å°†å…¨å±€ env æ˜ å°„åˆ°æ­¤ Step çš„ç¯å¢ƒå˜é‡ä¸­ï¼Œé˜²æ­¢ NoneType é”™è¯¯
          SNOWFLAKE_ACCOUNT: ${{ env.SNOWFLAKE_ACCOUNT }}
          SNOWFLAKE_USER: ${{ env.SNOWFLAKE_USER }}
          SNOWFLAKE_PASSWORD: ${{ env.SNOWFLAKE_PASSWORD }}
          DEPLOY_ENV: "DEV"
        run: |
          cd infrastructure
          python setup_tables.py

      # --- ç¬¬ä¸‰é˜¶æ®µï¼šSQL (é€šè¿‡ Python æ‰§è¡Œï¼Œå¢åŠ äº†ç©ºè¯­å¥å’Œçº¯æ³¨é‡Šè¿‡æ»¤) ---
      - name: Run Infrastructure SQL via Python
        env:
          SNOWFLAKE_ACCOUNT: ${{ env.SNOWFLAKE_ACCOUNT }}
          SNOWFLAKE_USER: ${{ env.SNOWFLAKE_USER }}
          SNOWFLAKE_PASSWORD: ${{ env.SNOWFLAKE_PASSWORD }}
        run: |
          python -c "
          import os
          import re
          import snowflake.snowpark as snowpark
          
          session = snowpark.Session.builder.configs({
              'account': '${{ env.SNOWFLAKE_ACCOUNT }}',
              'user': '${{ env.SNOWFLAKE_USER }}',
              'password': '${{ env.SNOWFLAKE_PASSWORD }}',
              'role': 'ACCOUNTADMIN',
              'warehouse': 'COMPUTE_WH',
              'database': 'COSMETICS_DB_DEV',
              'schema': 'COSMETICS'
          }).create()
          
          def is_valid_sql(sql):
              # ç§»é™¤æ³¨é‡Šï¼ˆ-- å’Œ /* */ï¼‰
              content = re.sub(r'--.*', '', sql)
              content = re.sub(r'/\*.*?\*/', '', content, flags=re.DOTALL)
              return len(content.strip()) > 0

          try:
              print('ğŸš€ æ­£åœ¨æ‰§è¡Œè¾…åŠ© SQL è„šæœ¬...')
              with open('infrastructure/create_streams.sql', 'r') as f:
                  # ä»¥åˆ†å·åˆ†å‰² SQL è¯­å¥
                  queries = [q.strip() for q in f.read().split(';') if q.strip()]
                  
                  for query in queries:
                      # å…³é”®ä¿®å¤ï¼šåªæœ‰å½“è¯­å¥ä¸­åŒ…å«æœ‰æ•ˆ SQL ä»£ç æ—¶æ‰æ‰§è¡Œ
                      if is_valid_sql(query):
                          print(f'æ‰§è¡Œä¸­: {query[:50]}...')
                          session.sql(query).collect()
                      else:
                          print('è·³è¿‡çº¯æ³¨é‡Š/ç©ºè¯­å¥æ®µè½')
              print('âœ… SQL éƒ¨ç½²æˆåŠŸï¼')
          except Exception as e:
              print(f'âŒ æ‰§è¡Œå¤±è´¥: {str(e)}')
              exit(1)
          finally:
              session.close()
          "